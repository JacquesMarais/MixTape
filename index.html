<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>MixTape</title>

        <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/pure-min.css" integrity="sha384-nn4HPE8lTHyVtfCBi5yW9d20FjT8BJwUXyWZT9InLYax14RDjBj46LmSztkmNP9w" crossorigin="anonymous">

        <script type="text/javascript" src="https://cdn.plyr.io/3.1.0/plyr.js"></script>
        <link rel="stylesheet" href="https://cdn.plyr.io/3.1.0/plyr.css" />
        <link rel="stylesheet" href="https://unpkg.com/simplebar@latest/dist/simplebar.css" />
        <script src="https://unpkg.com/simplebar@latest/dist/simplebar.js"></script>
        <script defer src="https://use.fontawesome.com/releases/v5.0.9/js/all.js" integrity="sha384-8iPTk2s/jMVj81dnzb/iFR2sdA7u06vHJyyLlAd4snFpCl/SnyUjRrbdJsw1pGIl" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="main.css" />
    </head>
    <body>
        <div id="overlay"></div>
        <div id="wrapper">
            <div id="thumb"><div class="plyr--audio" id="player">
                <iframe src="https://www.youtube.com/embed/eSjSozKL_EA" id="mainframe"></iframe>
            </div></div>

            <div id="controlwrapper"><div id="controls" class="phidden">
                <button id="prev"><i class="fas fa-step-backward fa-1x"></i>
                </button><button id="playpause"><i class="fas fa-play fa-1x"></i>
                </button><button id="next"><i class="fas fa-step-forward fa-1x"></i></button>
            </div></div>

            <input type="text" id="vid" placeholder="Video URL" hidden />
            <input type="submit" value="Go" id="vidgo" hidden/>

            <div id="desc" hidden><br/><br/>Paste/type the link to the YouTube video in the "Video URL" input box and press Go. Paste the correctly formatted playlist into this page by pressing Ctrl + V. Website design coming soon. Example of a correctly formatted playlist:<br/><br/>0:00 idealism - dont say a word<br/>
            2:22 through & through - mom.<br/>
            4:52 Aso - Lucid Dreams<br/>
            7:37 fujitsu - too far gone<br/>
            9:21 Arbour - elusive<br/><br/></br></div>

            <div id="trackwrapper" data-simplebar data-simplebar-auto-hide="false">
                <table id="tracklisttable">
                    <tbody id="tracklist">
                        <tr id="track0" class="currenttrack"><td>0:00</td><td>idealism - dont say a word
                        </td></tr><tr id="track1"><td>2:22</td><td>through &amp; through - mom.
                        </td></tr><tr id="track2"><td>4:52</td><td>Aso - Lucid Dreams
                        </td></tr><tr id="track3"><td>7:37</td><td>fujitsu - too far gone
                        </td></tr><tr id="track4"><td>9:21</td><td>Arbour - elusive
                        </td></tr><tr id="track5"><td>10:54</td><td>Philanthrope - RealEstate
                        </td></tr><tr id="track6"><td>12:32</td><td>idealism - midnight, somewhere
                        </td></tr><tr id="track7"><td>15:47</td><td>Harris Cole - Louie's lullaby
                        </td></tr><tr id="track8"><td>18:39</td><td>fujitsu - azure
                        </td></tr><tr id="track9"><td>20:49</td><td>Knowmadic - Fade
                        </td></tr><tr id="track10"><td>23:26</td><td>jinsang - undersea
                        </td></tr><tr id="track11"><td>24:36</td><td>KUPLA - Still Breathing
                        </td></tr><tr id="track12"><td>27:17</td><td>nohidea. - you don't have to cry
                        </td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        <script>
            var loadedlist = false;

            const player = new Plyr('#player', {
                autoplay: false
            });

            deftitle = "MixTape";

            player.on('ready', function(){

                sl("#overlay").style.display = "none";

                function changedata(){
                    document.title = deftitle + " Â» " + player.embed.getVideoData().title;
                };

                // Quick element selector
                function sl(s) {
                    return document.querySelector(s);
                }

                // Get query string value (https://stackoverflow.com/questions/901115/how-can-i-get-query-string-values-in-javascript)
                function par(name, url) {
                    if (!url) url = window.location.href;
                    name = name.replace(/[\[\]]/g, "\\$&");
                    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                        results = regex.exec(url);
                    if (!results) return null;
                    if (!results[2]) return '';
                    return decodeURIComponent(results[2].replace(/\+/g, " "));
                }

                // Get source from yt vid url
                function getsrc(u) {
                    if(/youtube\.com/.test(u)) return par("v", u);
                    else if(/youtu\.be/.test(u)) return u.replace(/(.*?)youtu.be\/+/, '').replace(/\?.*/, '');
                }

                sl("#vidgo").addEventListener("click", function(){
                    player.source = {
                        type: 'video',
                        sources: [
                            {
                                src: getsrc(sl("#vid").value),
                                provider: 'youtube',
                            },
                        ],
                    };
                    changedata();
                    loadedlist = false;
                    player.pause();
                });

                var play = true;

                sl("#playpause").addEventListener("click", function(){
                    if(!loadedlist) return;

                    var icon = this.querySelector("i");

                    if(!play){
                         player.play();
                         icon.className = "fas fa-pause";
                    }
                    else {
                        player.pause();
                        icon.className = "fas fa-play";
                    }

                    play = play ? false: true;
                });

                var times = [],
                    tracks = [];

                document.body.addEventListener("paste", function(e){
                    sl("#tracklist").innerHTML = "";
                    times = [];
                    tracks = [];

                    player.play();

                    sl("#controls").className = "";

                    var data = e.clipboardData.getData('Text');
                    if(/youtu\.?be/.test(data)) return;

                    data = data.replace(/\[([0-9]+):([0-9]+)\]/g, "$1:$2");

                    var vals = data.split(/(?=[0-9][0-9]:)/g),
                        val0 = vals[0].split(/(?=[0-9]:)/g);
                    vals.shift();
                    vals = val0.concat(vals);
                    var item = 0;
                    vals.forEach(function(s, i){
                        // s = string, i = position
                        if(!/\:/.test(s)) return;

                        var timeval = s.match(/([0-9]+):([0-9]+)/)[0],
                            time = parseInt(timeval.split(':')[0] * 60) + (parseInt(timeval.split(':')[1])),
                            track = s.replace(timeval + " ", '').replace('\n', '');

                        console.log(time, track);

                        sl("#tracklist").insertAdjacentHTML("beforeEnd", "<tr id='track" + item + "'><td>" + timeval + "</td><td>" + track + "</td></tr>");

                        sl("#track0").className = "currenttrack";

                        loadedlist = true;

                        times.push(time);
                        tracks.push(track);
                        item++;
                    });
                    document.querySelectorAll("tr").forEach(function(e){
                            e.addEventListener("click", function(){
                            var selectedtrack = this.id.replace("track", '');
                            player.currentTime = times[selectedtrack];
                            currenttrack = selectedtrack;
                            console.log(times[selectedtrack]);
                        });
                    });
                });

                var currenttrack = 0;

                player.on('timeupdate', function(){
                    if(player.currentTime == times[currenttrack + 1]) currenttrack++;
                    if(!sl(".currenttrack")) return;
                    sl(".currenttrack").className = "";
                    sl("#track" + currenttrack).className = "currenttrack";
                });

                sl("#next").addEventListener("click", function(){
                    if(!loadedlist) return;
                    player.currentTime = times[currenttrack + 1];
                    currenttrack++;
                });
            });
        </script>
    </body>
</html>
